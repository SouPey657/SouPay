<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SouPey</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SouPey">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root { --paypay-red: #ff0033; --bg-gray: #f4f4f6; }
        body { font-family: -apple-system, sans-serif; background: var(--bg-gray); margin: 0; color: #333; user-select: none; }
        
        #login-screen { position: fixed; inset: 0; background: white; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-logo { font-size: 3.5rem; font-weight: 900; color: var(--paypay-red); font-style: italic; margin-bottom: 40px; }
        .login-input { width: 80%; padding: 15px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 12px; font-size: 1rem; }
        .btn-login { background: var(--paypay-red); color: white; border: none; padding: 16px; width: 80%; border-radius: 30px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-login:active { opacity: 0.7; transform: scale(0.95); }

        .top-header { background: white; padding: 45px 15px 10px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .main-wallet-card { background: white; margin: 10px 15px; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); text-align: center; }
        #qr-img { width: 160px; height: 160px; margin: 10px 0; }

        .action-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; background: white; margin: 0 15px; padding: 15px 5px; border-radius: 20px; }
        .action-item { text-align: center; font-size: 0.7rem; font-weight: bold; cursor: pointer; }
        .action-icon { width: 50px; height: 50px; background: #fff1f3; color: var(--paypay-red); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 5px; font-size: 1.4rem; }

        .balance-card { background: white; margin: 15px; padding: 15px 20px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; }
        .bal-val { font-size: 1.4rem; font-weight: 900; }

        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; padding: 10px 0 25px; z-index: 100; }
        .nav-item { text-align: center; font-size: 0.6rem; color: #888; flex: 1; cursor: pointer; }
        .nav-item i { font-size: 1.5rem; display: block; margin-bottom: 3px; }
        .nav-pay-btn { background: var(--paypay-red); color: white; width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-top: -35px; border: 5px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; }

        #pay-modal { position: fixed; bottom: 0; width: 100%; background: white; border-radius: 25px 25px 0 0; transform: translateY(100%); transition: 0.3s; z-index: 1001; padding: 20px 0 40px; }
        #pay-modal.open { transform: translateY(0); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1000; }
        .amount-input-area { text-align: center; padding: 20px; }
        .amount-input-area input { font-size: 3.5rem; width: 80%; border: none; border-bottom: 2px solid #eee; text-align: center; outline: none; font-weight: bold; }
        .btn-confirm { background: var(--paypay-red); color: white; border: none; padding: 18px; width: 90%; margin: 0 5%; border-radius: 30px; font-weight: bold; font-size: 1.2rem; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-logo">SouPey</div>
        <input type="text" id="login-name" class="login-input" placeholder="ユーザー名">
        <input type="password" id="login-pass" class="login-input" placeholder="パスワード">
        <button class="btn-login" onclick="doLogin()">ログイン</button>
        <p id="login-error" style="color:red; font-size:0.8rem; margin-top:15px;"></p>
    </div>

    <div id="main-app" style="display:none;">
        <div class="top-header">
            <div><i class="fas fa-bars"></i> <span id="user-display">---</span></div>
            <i class="far fa-bell"></i>
        </div>

        <div class="main-wallet-card">
            <div style="font-size:0.7rem; color:#888;"><i class="fas fa-lock"></i> エンドツーエンド暗号化通信</div>
            <div class="qr-area"><img id="qr-img" src="" alt="QR"></div>
            <div id="qr-info" style="font-size:0.9rem; font-weight:bold; color:var(--paypay-red);">¥ 1,000 設定中</div>
        </div>

        <div class="action-grid">
            <div class="action-item"><div class="action-icon"><i class="fas fa-camera"></i></div>スキャン</div>
            <div class="action-item"><div class="action-icon"><i class="fas fa-paper-plane"></i></div>送る</div>
            <div class="action-item" onclick="alert('保有ポイント: ' + document.getElementById('pt-display').innerText + ' pt')"><div class="action-icon"><i class="fas fa-coins"></i></div>ポイント</div>
            <div class="action-item" onclick="openModal('charge')"><div class="action-icon"><i class="fas fa-plus-circle"></i></div>チャージ</div>
        </div>

        <div class="balance-card">
            <span><i class="fas fa-parking" style="color:var(--paypay-red);"></i> ポイント</span>
            <span class="bal-val"><span id="pt-display">0</span> pt</span>
        </div>
        <div class="balance-card" style="margin-top:-5px;">
            <span><i class="fas fa-yen-sign" style="color:var(--paypay-red);"></i> 残高</span>
            <span class="bal-val">¥ <span id="bal-display">0</span></span>
        </div>

        <div class="nav-bar">
            <div class="nav-item" style="color:var(--paypay-red);" onclick="location.reload()"><i class="fas fa-home"></i>ホーム</div>
            <div class="nav-item" onclick="location.href='https://sougomassage-smart.webnode.jp/'"><i class="fas fa-globe"></i>サイト</div>
            <div class="nav-pay-btn" onclick="openModal('pay')"><i class="fas fa-qrcode"></i></div>
            <div class="nav-item" onclick="window.location.href='https://docs.google.com/spreadsheets/d/1vN4H1eO4H5_VscfGv2m-68_70oAit8-71e-S5D2Y3pQ/edit'"><i class="fas fa-history"></i>履歴</div>
            <div class="nav-item" onclick="logout()"><i class="fas fa-user-circle"></i>設定</div>
        </div>
    </div>

    <div class="modal-overlay" id="overlay" onclick="closeModal()"></div>
    <div id="pay-modal">
        <div style="width:40px; height:5px; background:#ddd; border-radius:5px; margin:0 auto 20px;"></div>
        <h3 id="modal-title" style="text-align:center;">金額設定</h3>
        <div class="amount-input-area">
            <span style="font-size:1.5rem;">¥</span>
            <input type="number" id="input-amount" value="1000">
        </div>
        <button class="btn-confirm" onclick="applySettings()">設定を適用</button>
    </div>

    <script>
        // 【重要】新しいGAS URLを適用済み
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwzPTdXvPIAnNES3OjB5ImiWLUpIWf2FYuZKHlzpoeWM7fD7trTJDM_Vf0bDqrd4RaeTg/exec";
        
        let myName = localStorage.getItem('pp_user');
        let myPass = localStorage.getItem('pp_pass');
        let mode = "pay";

        window.onload = () => { 
            if(myName && myPass){ 
                document.getElementById('login-screen').style.display='none'; 
                document.getElementById('main-app').style.display='block'; 
                loadData(); 
            } 
        };

        async function doLogin() {
            const n = document.getElementById('login-name').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            if(!n || !p) return;

            document.getElementById('login-error').innerText = "セキュリティ検証中...";

            try {
                const res = await fetch(GAS_URL, {
                    method: "POST",
                    mode: "no-cors", // 一部の環境でのエラー回避
                    body: JSON.stringify({ action: "login", name: n, pass: p })
                });
                // no-corsの場合はレスポンスの中身が見えないため、通常フェッチを試行
                const secureRes = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "login", name: n, pass: p })
                });
                const d = await secureRes.json();
                if(d.status === "success"){
                    localStorage.setItem('pp_user', d.name);
                    localStorage.setItem('pp_pass', p);
                    location.reload();
                } else {
                    document.getElementById('login-error').innerText = d.message;
                }
            } catch(e) { 
                document.getElementById('login-error').innerText = "サーバー未承認または接続エラー"; 
            }
        }

        async function loadData() {
            document.getElementById('user-display').innerText = myName + " 様";
            try {
                const res = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "login", name: myName, pass: myPass })
                });
                const d = await res.json();
                if(d.status === "success"){
                    document.getElementById('bal-display').innerText = Number(d.balance).toLocaleString();
                    document.getElementById('pt-display').innerText = Number(d.point).toLocaleString();
                    updateQR();
                }
            } catch(e) { console.error("Data load failed"); }
        }

        function openModal(m) {
            mode = m;
            document.getElementById('modal-title').innerText = m === 'pay' ? "支払い金額設定" : "チャージ金額設定";
            document.getElementById('overlay').style.display = "block";
            document.getElementById('pay-modal').classList.add('open');
        }

        function closeModal() {
            document.getElementById('overlay').style.display = "none";
            document.getElementById('pay-modal').classList.remove('open');
        }

        function applySettings() {
            updateQR();
            const amt = document.getElementById('input-amount').value;
            document.getElementById('qr-info').innerText = `¥ ${Number(amt).toLocaleString()} ${mode==='pay'?'設定中':'チャージ用'}`;
            closeModal();
        }

        function updateQR() {
            const amt = document.getElementById('input-amount').value || 0;
            const data = JSON.stringify({ t: mode==='pay'?'p':'c', a: parseInt(amt), s: myName });
            document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(data)}`;
        }

        function logout() { if(confirm("セキュリティ確保のためログアウトしますか？")){ localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
