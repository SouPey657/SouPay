<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SouPay</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/SouPay/icon/main/sp.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root { --pay-red: #ff0033; }
        body { font-family: -apple-system, sans-serif; background: #f4f4f6; margin: 0; user-select: none; }
        .top-nav { background: var(--pay-red); color: white; padding: 50px 20px 25px; text-align: center; }
        .balance-value { font-size: 3.2rem; font-weight: 900; line-height: 1; }
        .qr-card { background: white; margin: -20px 15px 15px; border-radius: 25px; padding: 25px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        #qr-img { width: 190px; height: 190px; border-radius: 10px; }
        #login-screen { position: fixed; inset: 0; background: white; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-input { width: 80%; padding: 15px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 12px; }
        .btn-red { width: 85%; padding: 16px; border-radius: 30px; background: var(--pay-red); color: white; border: none; font-weight: bold; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0 30px; border-top: 1px solid #eee; }
    </style>
</head>
<body>
    <div id="login-screen">
        <h1 style="color:var(--pay-red); font-size:3rem; font-style:italic;">SouPay</h1>
        <input type="text" id="login-name" class="login-input" placeholder="ユーザー名">
        <input type="password" id="login-pass" class="login-input" placeholder="パスワード">
        <button class="btn-red" onclick="handleAuth('login')">ログイン</button>
    </div>

    <div id="main-app" style="display:none;">
        <div class="top-nav">
            <div id="user-display" style="font-size:0.8rem; margin-bottom:5px;">---</div>
            <div class="balance-value">¥ <span id="bal-display">0</span></div>
        </div>
        <div class="qr-card">
            <img id="qr-img" src="">
            <div id="qr-info" style="color:var(--pay-red); font-weight:bold; margin-top:10px;">¥ 1,000</div>
        </div>
        <div style="text-align:center; padding: 20px;">
            <button onclick="openModal('charge')" style="padding:10px 20px; border-radius:20px; border:1px solid #ddd;">金額変更</button>
        </div>
        <div class="nav-bar">
            <div onclick="location.reload()"><i class="fas fa-home fa-lg" style="color:var(--pay-red);"></i></div>
            <div onclick="localStorage.clear();location.reload()"><i class="fas fa-sign-out-alt fa-lg"></i></div>
        </div>
    </div>

    <script>
        const GAS_URL = "あなたのGASデプロイURL";
        const API_KEY = "SouPay_Secure_2026";
        let myName = localStorage.getItem('sp_user');
        let mode = "pay";

        window.onload = () => { if(myName){ document.getElementById('login-screen').style.display='none'; document.getElementById('main-app').style.display='block'; loadData(); updateQR(1000); } };

        async function handleAuth(type) {
            const n = document.getElementById('login-name').value;
            const p = document.getElementById('login-pass').value;
            const res = await fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:type,name:n,pass:p,apiKey:API_KEY})});
            const d = await res.json();
            if(d.status==="success") { localStorage.setItem('sp_user',n); location.reload(); } else { alert(d.message); }
        }

        async function loadData() {
            const res = await fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"login",name:myName,pass:"dummy",apiKey:API_KEY})});
            const d = await res.json();
            if(d.status==="success") document.getElementById('bal-display').innerText = d.balance.toLocaleString();
        }

        function updateQR(amt) {
            const data = { t: mode==='pay'?'p':'c', a: parseInt(amt), s: myName };
            document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(JSON.stringify(data))}`;
            document.getElementById('qr-info').innerText = `¥ ${Number(amt).toLocaleString()}`;
        }
        function openModal(m){ let a = prompt("金額","1000"); if(a) updateQR(a); }
    </script>
</body>
</html>
